// 註冊 Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js');
  });
}

// 全域當前顯示的年月
let currentDate = new Date();

// 分頁切換：保留原本的切換邏輯
document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    btn.classList.add('active');
    document.getElementById('view-' + btn.dataset.view).classList.remove('hidden');
    if (btn.dataset.view === 'calendar') {
      generateCalendar(currentDate);
    }
  });
});

// 1. 日曆產生函式
function generateCalendar(date = new Date()) {
  currentDate = date;
  const calendarEl = document.getElementById('calendar');
  const titleEl    = document.getElementById('calendar-title');
  calendarEl.innerHTML = '';

  const year  = date.getFullYear();
  const month = date.getMonth(); // 0-based

  // 更新標題
  titleEl.textContent = `${year} 年 ${month + 1} 月`;

  // 建立表格
  const table = document.createElement('table');
  table.classList.add('calendar-table');

  // 建表頭
  const weekdays = ['日','一','二','三','四','五','六'];
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  weekdays.forEach(w => {
    const th = document.createElement('th');
    th.textContent = w;
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  // 建表身
  const tbody = document.createElement('tbody');
  const firstDay    = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let row = document.createElement('tr');
  // 補空格
  for (let i = 0; i < firstDay; i++) {
    row.appendChild(document.createElement('td'));
  }
  // 填日期
  for (let day = 1; day <= daysInMonth; day++) {
    if (row.children.length === 7) {
      tbody.appendChild(row);
      row = document.createElement('tr');
    }
    const cell = document.createElement('td');
    cell.textContent = day;

    // 格子點擊事件：切到打卡頁，並載入該日資料
    const iso = new Date(year, month, day)
                    .toISOString()
                    .split('T')[0];
    cell.addEventListener('click', () => {
      // 切換 tab
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
      const entryBtn = document.querySelector('.tab[data-view="entry"]');
      entryBtn.classList.add('active');
      document.getElementById('view-entry').classList.remove('hidden');

      // 填日期
      document.getElementById('entry-date').value = iso;
      // 載入資料
      const raw = localStorage.getItem(iso);
      if (raw) {
        const data = JSON.parse(raw);
        document.getElementById('bleed-level').value = data.bleedLevel;
        // 重設所有 checkbox
        document.querySelectorAll('#entry-form input[type=checkbox]')
          .forEach(cb => cb.checked = false);
        data.symptoms.forEach(sym => {
          const cb = document.querySelector(`#entry-form input[value="${sym}"]`);
          if (cb) cb.checked = true;
        });
      } else {
        // 沒資料就清空選項
        document.getElementById('bleed-level').value = 2;
        document.querySelectorAll('#entry-form input[type=checkbox]')
          .forEach(cb => cb.checked = false);
      }
    });

    // 如果已經有打卡，套用高亮 class
    if (localStorage.getItem(iso)) {
      cell.classList.add('filled');
    }

    row.appendChild(cell);
  }
  // 補最後空格
  while (row.children.length < 7) {
    row.appendChild(document.createElement('td'));
  }
  tbody.appendChild(row);

  table.appendChild(tbody);
  calendarEl.appendChild(table);
}

// 2. 打卡表單儲存處理
document.getElementById('entry-form').addEventListener('submit', e => {
  e.preventDefault();
  const dateStr = document.getElementById('entry-date').value;
  const bleed   = document.getElementById('bleed-level').value;
  const symptoms = Array.from(
    document.querySelectorAll('#entry-form input[type=checkbox]:checked')
  ).map(cb => cb.value);

  // 存 localStorage
  localStorage.setItem(dateStr, JSON.stringify({
    bleedLevel: bleed,
    symptoms: symptoms
  }));

  // 重新畫日曆高亮
  generateCalendar(currentDate);
  alert(`已記錄 ${dateStr}`);
});

// 3. 頁面初次載入時畫一次日曆
window.addEventListener('load', () => generateCalendar());
